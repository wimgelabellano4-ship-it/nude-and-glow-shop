<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seller Center | Nude & Glow</title>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #FDFCF0; --primary: #D4A373; --accent: #5D4037; --white: #FFFFFF; --text: #333; --sidebar: #2C2C2C; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Poppins', sans-serif; margin: 0; display: flex; flex-direction: column; min-height: 100vh; }
        h1, h2, h3 { font-family: 'Playfair Display', serif; }
        
        /* AUTH SCREEN */
        #authScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #2C2C2C; z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .auth-box { background: white; padding: 40px; border-radius: 12px; width: 350px; text-align: center; }
        .toggle-link { color: var(--primary); cursor: pointer; font-size: 0.85rem; margin-top: 15px; display: block; text-decoration: underline; }
        
        /* MOBILE HEADER */
        .mobile-header { display: none; background: white; padding: 15px 20px; border-bottom: 1px solid #ddd; justify-content: space-between; align-items: center; }
        .menu-toggle { background: none; border: none; font-size: 1.8rem; color: var(--accent); cursor: pointer; }
        
        /* DASHBOARD LAYOUT */
        #dashboard { display: none; width: 100%; flex: 1; min-height: 100vh; }
        .sidebar { width: 260px; background: var(--sidebar); color: #ccc; padding: 30px 20px; display: flex; flex-direction: column; transition: 0.3s; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); margin-bottom: 50px; text-align: center; text-transform: uppercase; border-bottom: 1px solid #444; padding-bottom: 20px; }
        .menu-item { padding: 15px; cursor: pointer; display: flex; align-items: center; gap: 12px; border-radius: 8px; margin-bottom: 5px; transition: 0.3s; font-weight: 500; }
        .menu-item:hover, .menu-item.active { background: var(--primary); color: white; transform: translateX(5px); }
        .content { flex: 1; padding: 40px; overflow-y: auto; background: #F4F4F4; }
        .card { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.05); margin-bottom: 25px; }
        
        /* INPUTS & TABLES */
        input, select, button { padding: 12px; margin: 8px 0; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 6px; font-family: 'Poppins', sans-serif; }
        button { background: var(--accent); color: white; border: none; cursor: pointer; font-weight: 600; transition: 0.3s; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
        th { text-align: left; padding: 15px; background: #EEE; color: var(--accent); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #eee; font-size: 0.9rem; color: #555; vertical-align: middle; }
        img.preview { width: 50px; height: 50px; object-fit: cover; border-radius: 6px; border: 1px solid #eee; }
        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: bold; text-transform: uppercase; display: inline-block; }
        .bg-proc { background: #FFF3E0; color: #E65100; } .bg-ship { background: #E3F2FD; color: #1565C0; } .bg-del { background: #E8F5E9; color: #2E7D32; }
        
        /* CHAT STYLES */
        .msg-container { border: 1px solid #eee; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #fafafa; }
        .msg-scroll-area { max-height: 200px; overflow-y: auto; background: white; padding: 10px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 10px; }
        .msg-bubble { padding: 8px 12px; border-radius: 10px; margin-bottom: 5px; font-size: 0.9rem; display: block; width: fit-content; max-width: 80%; }
        .msg-buyer { background: #eee; color: #333; margin-right: auto; border-top-left-radius: 0; }
        .msg-admin { background: #D4A373; color: white; margin-left: auto; text-align: right; border-top-right-radius: 0; }
        .reply-box { display: flex; gap: 10px; align-items: center; }
        .reply-input { flex: 1; margin: 0 !important; background: white; border: 1px solid #ccc; }

        @media (max-width: 768px) { body { display: block; } .mobile-header { display: flex; } #dashboard { display: block; } .sidebar { display: none; width: 100%; height: auto; padding: 10px; } .sidebar.show { display: flex; } .logo { display: none; } .content { padding: 15px; } table { display: block; overflow-x: auto; } }
    </style>
</head>
<body>

    <div id="authScreen">
        <div class="auth-box" id="loginBox">
            <h2>Seller Login</h2><p style="color:#777; font-size:0.9rem;">Manage your shop</p>
            <input type="text" id="lUser" placeholder="Username"><input type="password" id="lPass" placeholder="Password">
            <button onclick="login()">ENTER DASHBOARD</button><span class="toggle-link" onclick="toggleAuth('register')">New Seller? Register Here.</span>
        </div>
        <div class="auth-box" id="registerBox" style="display:none;">
            <h2>Register Shop</h2><input type="text" id="rShopName" placeholder="Shop Name">
            <input type="number" id="rPhone" placeholder="Mobile No. (09xxxxxxxxx)">
            <input type="text" id="rUser" placeholder="Username"><input type="password" id="rPass" placeholder="Password">
            <button onclick="register()">CREATE ACCOUNT</button><span class="toggle-link" onclick="toggleAuth('login')">Back to Login</span>
        </div>
    </div>

    <div class="mobile-header"><h3>SELLER CENTER</h3><button class="menu-toggle" onclick="toggleSidebar()"><i class="ph ph-list"></i></button></div>

    <div id="dashboard">
        <div class="sidebar" id="sidebar">
            <div class="logo">NUDE & GLOW<br><span style="font-size:0.7rem; color:#888;">ADMIN PANEL</span></div>
            <div class="menu-item active" onclick="showSection('products'); toggleSidebar()"><i class="ph ph-package"></i> Products</div>
            <div class="menu-item" onclick="showSection('orders'); toggleSidebar()"><i class="ph ph-receipt"></i> Orders <span id="notifBadge" style="background:red; color:white; font-size:0.6rem; padding:2px 6px; border-radius:10px; margin-left:auto; display:none;">!</span></div>
            <div class="menu-item" onclick="showSection('messages'); toggleSidebar()"><i class="ph ph-chat-circle-dots"></i> Messages <span id="msgBadge" style="background:red; color:white; font-size:0.6rem; padding:2px 6px; border-radius:10px; margin-left:auto; display:none;">!</span></div>
            <div style="margin-top:auto;"><div class="menu-item" onclick="resetSystem()" style="color:#ff6b6b; border-top:1px solid #444;"><i class="ph ph-trash"></i> Reset System</div><div class="menu-item" onclick="logout()"><i class="ph ph-sign-out"></i> Logout</div></div>
        </div>

        <div class="content">
            <h2 id="welcomeMsg" style="margin-bottom:20px;">Dashboard</h2>
            
            <div id="sec-products">
                <div class="card">
                    <h3 style="margin-top:0;">Add Product</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px;"><input type="text" id="pName" placeholder="Product Name"><input type="number" id="pPrice" placeholder="Price"></div>
                    <input type="file" id="pImgFile" accept="image/*"><select id="pCat"><option>Skincare</option><option>Makeup</option><option>Body Care</option></select>
                    <label style="font-size:0.8rem; font-weight:bold; color:var(--accent);">Shades / Variants (Optional)</label>
                    <input type="text" id="pShades" placeholder="e.g. Nude, Pink, Red (comma separated)">
                    <button onclick="processAndAddProduct()" style="margin-top:15px;">UPLOAD</button><p id="statusMsg" style="display:none; color:green; text-align:center;">Processing...</p>
                </div>
                <div class="card"><h3 style="margin-top:0;">Inventory</h3><table id="productTable"><thead><tr><th>Img</th><th>Details</th><th>Price</th><th>Action</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="sec-orders" style="display:none;">
                <div class="card"><h3 style="margin-top:0;">Orders</h3><table id="orderTable"><thead><tr><th>ID</th><th>Customer</th><th>Items</th><th>Total</th><th>Status</th></tr></thead><tbody></tbody></table></div>
            </div>

            <div id="sec-messages" style="display:none;">
                <div class="card"><h3 style="margin-top:0;">Customer Inquiries</h3><div id="chatFeed"></div></div>
            </div>
        </div>
    </div>

    <script>
        let currentSeller = null;
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }
        function toggleAuth(mode) { document.getElementById('loginBox').style.display = mode==='login'?'block':'none'; document.getElementById('registerBox').style.display = mode==='register'?'block':'none'; }
        
        function register() {
            const s=document.getElementById('rShopName').value, u=document.getElementById('rUser').value, p=document.getElementById('rPass').value, ph=document.getElementById('rPhone').value;
            if(!s||!u||!p||!ph) return alert("Fill all fields");
            const d=JSON.parse(localStorage.getItem('sellers'))||[]; if(d.find(x=>x.user===u)) return alert("User exists"); d.push({shop:s,user:u,pass:p,phone:ph}); localStorage.setItem('sellers',JSON.stringify(d)); alert("Registered!"); toggleAuth('login');
        }
        function login() {
            const u=document.getElementById('lUser').value, p=document.getElementById('lPass').value; const d=JSON.parse(localStorage.getItem('sellers'))||[]; const s=d.find(x=>x.user===u&&x.pass===p); if(s){ localStorage.setItem('activeSeller',JSON.stringify(s)); startSession(s); } else alert("Invalid Login");
        }
        function startSession(s) {
            currentSeller=s; document.getElementById('authScreen').style.display='none'; document.getElementById('dashboard').style.display=window.innerWidth>768?'flex':'block'; document.getElementById('welcomeMsg').innerText="Hello, "+s.shop; 
            loadMyProducts(); loadMyOrders(); loadChats();
            
            // --- SMART INTERVAL: Only refresh chat if NOT typing ---
            setInterval(() => {
                loadMyOrders();
                if (document.activeElement.tagName !== "INPUT") { loadChats(); }
            }, 2000);
        }
        function logout() { localStorage.removeItem('activeSeller'); location.reload(); }

        // PRODUCTS
        function resizeImage(f,c){const r=new FileReader();r.onload=e=>{const i=new Image();i.src=e.target.result;i.onload=()=>{const v=document.createElement('canvas'),x=v.getContext('2d'),s=300/i.width;v.width=300;v.height=i.height*s;x.drawImage(i,0,0,v.width,v.height);c(v.toDataURL('image/jpeg',0.7))}};r.readAsDataURL(f)}
        function processAndAddProduct(){ const n=document.getElementById('pName').value,p=document.getElementById('pPrice').value,c=document.getElementById('pCat').value,s=document.getElementById('pShades').value; if(!n||!p)return alert("Details needed"); document.getElementById('statusMsg').style.display='block'; const save=i=>{const d=JSON.parse(localStorage.getItem('products'))||[]; d.push({id:Date.now(),sellerUser:currentSeller.user,sellerShop:currentSeller.shop,name:n,price:Number(p),cat:c,img:i,shades:s}); localStorage.setItem('products',JSON.stringify(d)); alert("Added!"); document.getElementById('statusMsg').style.display='none'; loadMyProducts(); document.getElementById('pName').value=''; document.getElementById('pPrice').value=''; }; const f=document.getElementById('pImgFile').files[0]; if(f)resizeImage(f,save);else save('https://placehold.co/300?text=No+Image'); }
        function loadMyProducts(){ const d=JSON.parse(localStorage.getItem('products'))||[]; const t=document.querySelector('#productTable tbody'); t.innerHTML=''; d.filter(x=>x.sellerUser===currentSeller.user).forEach(x=>{t.innerHTML+=`<tr><td><img src="${x.img}" class="preview"></td><td>${x.name}<br><small>${x.cat}</small></td><td>â‚±${x.price}</td><td><button onclick="delProd(${x.id})" style="background:#ff6b6b;padding:5px;">Del</button></td></tr>`}); }
        function delProd(id){ if(confirm("Delete?")){let d=JSON.parse(localStorage.getItem('products'));localStorage.setItem('products',JSON.stringify(d.filter(x=>x.id!==id)));loadMyProducts();} }

        // ORDERS
        function loadMyOrders(){ const d=JSON.parse(localStorage.getItem('orders'))||[]; const t=document.querySelector('#orderTable tbody'); t.innerHTML=''; const m=d.filter(x=>x.items.some(i=>i.sellerUser===currentSeller.user)); if(m.length===0){document.getElementById('notifBadge').style.display='none';t.innerHTML='<tr><td colspan="5" style="text-align:center;">No orders.</td></tr>';return;} document.getElementById('notifBadge').style.display='inline-block'; m.forEach(o=>{const tot=o.items.filter(i=>i.sellerUser===currentSeller.user).reduce((a,b)=>a+b.price,0); t.innerHTML+=`<tr><td><small>${o.id}</small></td><td><b>${o.customer.name}</b><br><small>ðŸ“ž ${o.customer.phone||'N/A'}</small></td><td>${o.items.length} items</td><td>â‚±${tot}</td><td><select onchange="upStat('${o.id}',this.value)" style="padding:5px;"><option ${o.status=='Processing'?'selected':''}>Processing</option><option ${o.status=='Shipped'?'selected':''}>Shipped</option><option ${o.status=='Delivered'?'selected':''}>Delivered</option></select><br><span class="badge ${o.status=='Delivered'?'bg-del':(o.status=='Shipped'?'bg-ship':'bg-proc')}">${o.status}</span></td></tr>`; }); }
        function upStat(id,s){ let d=JSON.parse(localStorage.getItem('orders')); let x=d.find(i=>i.id===id); if(x){x.status=s;localStorage.setItem('orders',JSON.stringify(d));} }

        // --- FIXED CHAT (Anti-Refresh & Name Fix) ---
        function loadChats() {
            if (document.activeElement.tagName === "INPUT") return; // STOP refreshing if typing

            const allChats = JSON.parse(localStorage.getItem('chats')) || [];
            const feed = document.getElementById('chatFeed');
            const grouped = {};
            
            allChats.forEach(c => {
                const name = c.customer || "Guest"; // Fix "undefined" name
                if(!grouped[name]) grouped[name] = [];
                grouped[name].push(c);
            });

            if(Object.keys(grouped).length === 0) {
                feed.innerHTML = '<p style="text-align:center; padding:20px; color:#999;">No messages yet.</p>';
                document.getElementById('msgBadge').style.display = 'none';
                return;
            }
            document.getElementById('msgBadge').style.display = 'inline-block';

            let content = '';
            for (const [customerName, messages] of Object.entries(grouped)) {
                const safeId = customerName.replace(/\s+/g, '_'); 
                let msgHtml = '';
                messages.forEach(m => {
                    const isAdmin = m.sender === 'Admin';
                    msgHtml += `<div class="msg-bubble ${isAdmin ? 'msg-admin' : 'msg-buyer'}"><b>${isAdmin ? 'You' : customerName}:</b> ${m.msg}</div>`;
                });

                content += `
                <div class="msg-container">
                    <h4 style="margin:0 0 10px 0; color:var(--accent); border-bottom:1px solid #ddd; padding-bottom:5px;">${customerName}</h4>
                    <div class="msg-scroll-area" id="box-${safeId}">${msgHtml}</div>
                    <div class="reply-box">
                        <input type="text" id="input-${safeId}" class="reply-input" placeholder="Type reply...">
                        <button onclick="sendReply('${customerName}', 'input-${safeId}')" style="width:auto; padding:0 20px;">Send</button>
                    </div>
                </div>`;
            }
            feed.innerHTML = content;
        }

        function sendReply(customerName, inputId) {
            const input = document.getElementById(inputId);
            const msg = input.value;
            if(!msg) return alert("Please type a message");

            const chats = JSON.parse(localStorage.getItem('chats')) || [];
            chats.push({ customer: customerName, sender: 'Admin', msg: msg, date: new Date().toLocaleString() });
            localStorage.setItem('chats', JSON.stringify(chats));
            
            input.value = '';
            loadChats();
        }

        function resetSystem(){if(confirm("DELETE ALL?")){localStorage.clear();location.reload();}}
        function showSection(id){['products','orders','messages'].forEach(s=>document.getElementById('sec-'+s).style.display='none');document.getElementById('sec-'+id).style.display='block';}
        
        const ss=JSON.parse(localStorage.getItem('activeSeller')); if(ss){startSession(ss);}
    </script>
</body>
</html>
